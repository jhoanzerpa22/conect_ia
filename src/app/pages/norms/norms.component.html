<!-- Start Breadcrumbs -->
<app-breadcrumbs title="{{getTitulo()}}" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>
<!-- End Breadcrumbs -->

<!--preloader-->
<div id="preloader" style="opacity: 0px !important;background-color: #000 !important;visibility: hidden;">
    <div id="status">
      <div class="spinner-border text-primary avatar-sm" role="status">
          <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
</div>

  <div class="row">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">{{ norma_id > 0 ? 'Editar' : 'Crear' }} {{getTitulo()}} {{ cuerpoLegal.titulo ? ' - ' + cuerpoLegal.titulo : ''}}</h4>
            </div><!-- end card header -->
            <div class="card-body form-steps">
              <!--<div class="text-center pt-3 pb-4 mb-1">
                      <h5>Signup Your Account</h5>
              </div>-->
              <form [formGroup]="cuerpoForm">
              <aw-wizard [navBarLayout]="'large-empty-symbols'" class="nav nav-pills progress-bar-tab custom-nav">
                <aw-wizard-step>
                    <ng-template awWizardStepSymbol>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill active" data-progressbar="custom-progress-bar" id="pills-gen-info-tab" data-bs-toggle="pill" data-bs-target="#pills-gen-info" type="button" role="tab" aria-controls="pills-gen-info" aria-selected="true">1</button>
                      </li>
                    </ng-template>
                    
                    <!--<form [formGroup]="cuerpoForm">-->
                      <div class="mb-4">
                          <div>
                              <h5 class="mb-1">Información General del {{getTitulo()}}</h5>
                              <p class="text-muted">Ingrese la información básica del {{getTitulo()}}</p>
                          </div>
                      </div>
                      <div class="row">

                        <input type="hidden" name="tipo" value="" formControlName="tipo" />

                        <div class="col-lg-12">
                            <div class="mb-3">
                                <label class="form-label" for="gen-info-norma-input">Id Norma</label>
                                <input type="text" class="form-control" id="gen-info-norma-input" formControlName="normaId"  #myNormaId (blur)="validNormaId(myNormaId.value)" placeholder="Identificador de Norma ..." required [ngClass]="{ 'is-invalid': f['normaId'].errors }" [readOnly]="norma_id">
                                <!-- submitted && -->
                                <div *ngIf="f['normaId'].errors" class="invalid-feedback" align="left">
                                    <div *ngIf="f['normaId'].errors['pattern']">El id de la norma debe ser numerico</div>
                                    <div *ngIf="f['normaId'].errors['required']">El id de la norma es requerido</div>
                                </div>
                            </div>
                        </div>

                          <div class="col-lg-12">
                              <div class="mb-3">
                                  <label class="form-label" for="gen-info-titulo-input">Título</label>
                                  <input type="text" class="form-control" id="gen-info-titulo-input" formControlName="titulo" placeholder="Decreto ..." required [ngClass]="{ 'is-invalid': f['titulo'].errors }">
                                  
                                <div *ngIf="f['titulo'].errors" class="invalid-feedback" align="left">
                                    <div *ngIf="f['titulo'].errors['required']">El titulo es requerido</div>
                                </div>
                              </div>
                          </div>
                          <div class="col-lg-12">
                              <div class="mb-3">
                                  <label class="form-label" for="gen-info-subtitulo-input">Sub Título</label>
                                  <input type="text" class="form-control" id="gen-info-subtitulo-input" formControlName="subtitulo" placeholder="Aprueba uso de ...">
                                  <!-- [ngClass]="{ 'is-invalid': submitted && f['subtitulo'].errors }"-->
                                <!--<div *ngIf="submitted && f['subtitulo'].errors" class="invalid-feedback" align="left">
                                    <div *ngIf="f['subtitulo'].errors['required']">El sub titulo es requerido</div>
                                </div>-->
                              </div>
                          </div>
                          <div class="col-lg-12">
                              <div class="mb-3">
                                  <label class="form-label" for="gen-info-ministerio-input">Organismo Emisor</label>
                                  <input type="text" class="form-control" id="gen-info-ministerio-input"  formControlName="organismo" placeholder="Ministerio de medio ambiente">
                              </div>
                          </div>
                          
                          <div class="col-lg-12">
                            <div class="mb-3">
                                <label class="form-label" for="gen-info-encabezado-input">Encabezado</label>
                                <input type="text" class="form-control" id="gen-info-encabezado-input"  formControlName="encabezado" placeholder="Encabezado ...">
                            </div>
                          </div>
                          
                          <div class="col-lg-6">
                            <div class="mb-3">
                                <label for="customername-field" class="form-label">Fecha Publicación</label>
                                <div class="form-icon right">
                                    <input [ngClass]="{ 'is-invalid': submitted && f['fechaPublicacion'].errors }" class="form-control form-control-icon flatpickr-input" id="publicacion-input" type="text" formControlName="fechaPublicacion" mwlFlatpickr [altInput]="true" [convertModelValue]="true">
                                    <i class="ri-calendar-todo-fill"></i>
                                    
                                    <div *ngIf="submitted && f['fechaPublicacion'].errors" class="invalid-feedback" align="left">
                                        <div *ngIf="f['fechaPublicacion'].errors['required']">La fecha de publicación es requerida</div>
                                    </div>
                                </div>
                            </div>
                          </div>
                          
                          <div class="col-lg-6">
                            <div class="mb-3">
                                <label for="customername-field" class="form-label">Fecha Promulgación</label>
                                <div class="form-icon right">
                                    <input [ngClass]="{ 'is-invalid': submitted && f['fechaPromulgacion'].errors }" class="form-control form-control-icon flatpickr-input" id="promulgacion-input" type="text" formControlName="fechaPromulgacion" mwlFlatpickr [altInput]="true" [convertModelValue]="true">
                                    <i class="ri-calendar-todo-fill"></i>
                                    
                                    <div *ngIf="submitted && f['fechaPromulgacion'].errors" class="invalid-feedback" align="left">
                                        <div *ngIf="f['fechaPromulgacion'].errors['required']">La fecha de promulgacion es requerida</div>
                                    </div>
                                </div>
                            </div>
                          </div>
                          
                          <div class="col-lg-12">
                              <div class="mb-3">
                                <label class="form-label" for="gen-info-ambito-input">Ámbito</label>
                                <select class="form-control form-select" aria-label="Ambito" formControlName="ambito" placeholder="Normativa ambiental">
                                    <!--<option value="" selected>Seleccione normativa </option>
                                    <option value="GENERAL">Normativa general</option>
                                    <option value="MA">Normativa ambiental</option>
                                    <option value="SST">Normativa SST</option>
                                    <option value="LABORAL">Normativa laboral</option>
                                    <option value="ENERGIA">Normativa de energía</option>-->
                                    <option value="" selected>Todos </option>
                                    <option *ngFor="let am of ambitos;" value="{{am.value}}">{{am.label}}</option>
                                    
                                </select>
                              </div>
                          </div>
                      </div>
                      <!--<div class="mb-3">
                          <label class="form-label" for="gen-info-password-input">Password</label>
                          <input type="password" class="form-control" id="gen-info-password-input" placeholder="Enter Password">
                      </div>-->
                    <!--</form>-->
                    <!-- wizard-tab -->
                    <div class="d-flex align-items-start gap-3 mt-4">
                      <button type="button" class="btn btn-success btn-label right ms-auto nexttab nexttab" (click)="saveCuerpoLegal()" data-nexttab="pills-info-desc-tab" awNextStep [disabled]="!cuerpoForm.valid"><i class="ri-arrow-right-line label-icon align-middle fs-16 ms-2"></i>Configurar</button>
                    </div>
                </aw-wizard-step>
  
                <aw-wizard-step>
                    <ng-template awWizardStepSymbol>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill" data-progressbar="custom-progress-bar" id="pills-info-desc-tab" data-bs-toggle="pill" data-bs-target="#pills-info-desc" type="button" role="tab" aria-controls="pills-info-desc" aria-selected="false">2</button>
                      </li>
                    </ng-template>
                    
                    <ng-container *ngIf="!addArticle && !addSubArticle && !editArticle">
                      <div class="row g-4 mb-4">
                        <div class="col-sm">
                            <h5 class="mb-1">Configurar</h5>
                            <p class="text-muted">Configura cada uno de los artículos de su {{getTitulo()}}</p>
                        </div>
                        <div class="col-sm-auto">
                                <button type="button" class="btn btn-info btn-label waves-effect right waves-light" (click)="showAddArticle()">Agregar<i class="ri-add-line label-icon align-middle fs-16"></i></button>
                        </div>
                       </div>

                       <div class="row g-4 mb-3">
                            <div style="min-height: 350px !important;" *ngIf="cuerpoLegal.articulos.length == 0">
                                
                                <div class="card" style="padding: 0px;">
                                <div class="card-body">
                                    <div style="text-align: center;width: 100%;font-size: 20px;"><!--class="position-absolute top-50"-->
                                        Aún no ha creado artículos para este {{getTitulo()}}
                                    </div>
                                </div>
                                </div>
                            </div>

                            <div style="min-height: 350px !important;" *ngIf="cuerpoLegal.articulos.length > 0">
                                
                                <div class="d-md-flex justify-content-sm-end gap-2">
                                    <div class="search-box" style="width: 20%;">
                                        <input type="text" class="form-control bg-light border-light" placeholder="Buscar..." value="" formControlName="busqueda" [(ngModel)]="search">
                                        <i class="ri-search-2-line search-icon"></i>
                                    </div>
                                </div>

                                <div style="padding: 0px;">

                                    <ng-container *ngFor="let ar of cuerpoLegal.articulos | filter:search; let i = index">
                                    
                                    <div class="list-group" *ngIf="!ar.eliminado">
        
                                            <div class="team-list list-view-filter row" style="cursor:pointer;">
                                                <div class="col">
                                                    <div class="card team-box" style="margin-bottom: 20px !important;">
                                                        <div class="team-cover">
                                                            
                                                        </div>
                                                        <div class="card-header">
                                                            <h4 class="card-title mb-0">{{ar.encabezado}}</h4>
                                                            <h5 class="text-muted">{{ar.titulo}}</h5>
                                                            <p>{{ar.contenido}}</p>
                                                        </div>
                                                        <div class="card-body p-4">                
                                                            <div class="row align-items-center team-row">
                                                                <div class="col team-settings">
                                                                    <div class="row">
                                                                        <div class="col">
                                                                            
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="col-lg-4 col"><!-- (click)="goEvaluation(ev.id)"-->
                                                                    <div class="row text-muted text-center">
                                                                        <div class="col-12 border-end border-end-dashed">
                                                                            <h5 class="mb-1" ><b>{{ar.empresa ? ar.empresa : ar.usuario.nombre +' '+ar.usuario.apellido}}</b></h5>
                                                                            <p class="text-muted mb-0">Creado por</p>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="col-lg-2 col">
                                                                    <div class="row text-muted text-center">
                                                                        <div class="col-12 border-end border-end-dashed">
                                                                            <h5 class="mb-1">{{ar.created_at}}</h5>
                                                                            <p class="text-muted mb-0">Fecha Creación</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
        
                                                                <div class="col-lg-2 col">
                                                                    <div class="row text-muted text-center">
                                                                        <div class="col-12 border-end border-end-dashed">
                                                                            <h5 class="mb-1">{{ar.updated_at}}</h5>
                                                                            <p class="text-muted mb-0">Fecha Modificación</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
        
                                                                <div class="col-lg-2 col">
                                                                    <div class="row text-muted text-center">
                                                                        <div class="col-12 border-end border-end-dashed">
                                                                            <h5 class="mb-1">{{ar.articulos ? ar.articulos.length : 0}}</h5>
                                                                            <p class="text-muted mb-0">Sub-Artículos</p>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="col-lg-2 col text-center">

                                                                    <span class="btn btn-info" 
                                                                    [style.cursor]="'pointer'" (click)="showAddSubArticle(i, ar)">
                                                                    <i class="ri-git-merge-line"></i>
                                                                    </span>
                                                                    
                                                                    <span style="margin-left:10px;" class="btn btn-primary" 
                                                                    [style.cursor]="'pointer'" (click)="showEditArticle(i, ar)" *ngIf="ar.id">
                                                                    <i class="ri-pencil-line"></i>
                                                                    </span>
                                                                    
                                                                    <span style="margin-left:10px;" class="btn btn-danger" 
                                                                    [style.cursor]="'pointer'" (click)="deleteArticle(i, ar)">
                                                                    <i class="ri-delete-bin-5-line"></i>
                                                                    </span>
                                                                    
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--end card-->
                                                </div>
                                            </div>
                                    </div>
                                </ng-container>
                            </div>
                            </div>
                    </div>
                       
                    <div class="d-flex align-items-start gap-3 mt-4">
                      <button type="button" class="btn btn-link text-decoration-none btn-label previestab" data-previous="pills-gen-info-tab" awPreviousStep><i class="ri-arrow-left-line label-icon align-middle fs-16 me-2"></i> Información</button>
                      <button type="button" class="btn btn-success btn-label right ms-auto nexttab nexttab" data-nexttab="pills-success-tab" awNextStep [disabled]="cuerpoLegal.articulos.length == 0"><i class="ri-arrow-right-line label-icon align-middle fs-16 ms-2"></i>Resumen</button>
                    </div>

                    </ng-container>
                    
                    <ng-container *ngIf="addArticle && !addSubArticle">
                        
                        <app-articles (backFunction)='hideAddArticle($event)' (addFunction)='saveArticulos($event)'></app-articles>
                    </ng-container>
                    
                    <ng-container *ngIf="editArticle && !addSubArticle">
                        
                        <app-articles [articulo_data]="articulo_padre" (backFunction)='hideAddArticle($event)' (editFunction)='editArticulos($event)'></app-articles>
                    </ng-container>
                    
                    <ng-container *ngIf="addSubArticle">
                        
                        <app-sub-articles [articulo_padre]="articulo_padre" (addFunction)='saveSubArticulos($event)' (backFunction)='hideAddSubArticle($event)'></app-sub-articles>
                    </ng-container>
                </aw-wizard-step>
  
                <aw-wizard-step>
                    <ng-template awWizardStepSymbol>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill" data-progressbar="custom-progress-bar" id="pills-success-tab" data-bs-toggle="pill" data-bs-target="#pills-success" type="button" role="tab" aria-controls="pills-success" aria-selected="false">3</button>
                      </li>
                    </ng-template>
                    
                        <div class="row g-4 mb-4">
                            <div class="col-sm">
                                <h5 class="mb-1">Resumen</h5>
                                <p class="text-muted">Resumen del {{getTitulo()}} que se incorporará a su base de datos</p>
                            </div>
                            <div class="col-sm-auto">
                                    <button type="button" class="btn btn-light waves-effect right waves-light" (click)="hideResumen()" *ngIf="subArticles.length > 0">Volver</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div>
                                <h5 class="card-title mb-0">{{cuerpoLegal.titulo}}</h5>
                                <h5 style="color: #405189;">{{cuerpoLegal.subtitulo}}</h5>
                                <p class="text-muted">{{cuerpoLegal.organismo}}</p>
                            </div>
                        </div>
                        
                        <!--<ng-container *ngIf="subArticles.length > 0">
                            
                            <ng-container *ngFor="let sub of subArticles; let su = index">
                                <div class="mb-4">
                                    <div>
                                        <h4 class="card-title mb-0">{{sub.encabezado}}</h4>
                                        <h5 class="text-muted">{{sub.titulo}}</h5>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>-->
  
                        <div class="row g-4 mb-3" *ngIf="resumen.articulos.length == 0">
                          <div class="card" style="padding: 0px;">
                              <div style="min-height: 350px !important;">
                                  
                                  <div class="card-body">
                                    <div style="text-align: center;width: 100%;font-size: 20px;"><!-- class="position-absolute top-50"-->
                                        Aún no ha creado artículos para este {{subArticles.length > 0 ? 'Artículo' : getTitulo()}}
                                    </div>
                                  </div>
                              </div>
                          </div>
                        </div>

                        <div class="row g-4 mb-3" *ngIf="resumen.articulos.length > 0">
                            <!--<div class="card" style="padding: 0px;">
                        <div style="min-height: 350px !important;">-->
                            
                            <ng-template #myArticles let-s="s" let-j="j">
                                <div class="team-list list-view-filter row" *ngIf="!s.eliminado">
                                    <div class="col">
                                        <div class="card team-box border">
                                            
                                            <div class="team-cover">
                                                
                                            </div>
                                            
                                            <div class="card-body p-4">   
                                                <h5 class="flex-grow-1 fw-semibold mb-0">{{s.encabezado}}
                                                    <span class="float-end" style="font-size: 20px;cursor:pointer;"><i class=" ri-arrow-up-s-line" (click)="hideArticles(j)" *ngIf="!validateShowArticles(j) && s.articulos.length > 0"></i></span>
                                                    <span class="float-end" style="font-size: 20px;cursor:pointer;" (click)="showArticles(j)" *ngIf="validateShowArticles(j) && s.articulos.length > 0"><i class=" ri-arrow-down-s-line"></i></span>
                                                </h5>
                                                <h5 style="color: #405189;">{{s.titulo}}</h5>
                                                <p class="text-muted">
                                                    {{s.contenido}}
                                                </p>
                                                
                                            <ng-container *ngIf="!validateShowArticles(j)">
                                                <ng-container *ngFor="let sub of s.articulos">
                        
                                                    <ng-container [ngTemplateOutlet]="myArticles" 
                                                    [ngTemplateOutletContext] ="{s:sub, j: (j + 100) }">
                                                    </ng-container>
                                        
                                                </ng-container>
                                            </ng-container>
                                                         
                                                <!--<div class="row align-items-center team-row">
                                                    <div class="col team-settings">
                                                        <div class="row">
                                                            <div class="col">
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-auto col pointer">
                                                        <div>
                                                            <h5 class="fs-16 mb-1" style="color: #405189;">
                                                            {{s.encabezado}}</h5>
                                                        </div>
                                                    </div>
                                                </div>-->
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            
                            </ng-template>

                                <ng-container *ngFor="let ar of resumen.articulos; let i = index; let impar = odd; let par = even;">
                                
                                <div class="card" *ngIf="!ar.eliminado"><!--style="box-shadow: none !important;"-->
                                    
                                    <div class="card-body border" [ngClass]="{'tono1': impar, 'tono2': par}">
                                        
                                        <h5 class="flex-grow-1 fw-semibold mb-0">{{ar.encabezado}}
                                            <span class="float-end" style="font-size: 20px;cursor:pointer;"><i class=" ri-arrow-up-s-line" (click)="hideArticles(i)" *ngIf="!validateShowArticles(i) && ar.articulos.length > 0"></i></span>
                                            <span class="float-end" style="font-size: 20px;cursor:pointer;" (click)="showArticles(i)" *ngIf="validateShowArticles(i) && ar.articulos.length > 0"><i class=" ri-arrow-down-s-line"></i></span>
                                        </h5>
                                        <h5 style="color: #405189;">{{ar.titulo}}</h5>
                                        <p class="text-muted">
                                            {{ar.contenido}}
                                        </p>
                                        
                                    <ng-container *ngIf="!validateShowArticles(i)">
                                        <ng-container *ngFor="let s of ar.articulos">
                
                                            <ng-container [ngTemplateOutlet]="myArticles" 
                                            [ngTemplateOutletContext] ="{s:s, j: (i + 100) }">
                                            </ng-container>
                                
                                        </ng-container>
                                    </ng-container>
                                    
                                    </div>
                                </div>
                            
                                        <!--<div class="team-list list-view-filter row" style="cursor:pointer;" (click)="viewResumen(i, ar)">
                                            <div class="col">
                                                <div class="card team-box" style="margin-bottom: 20px !important;">
                                                    <div class="team-cover">
                                                        
                                                    </div>
                                                    <div class="card-body">
                                                        <h4 class="card-title mb-0">{{ar.encabezado}}</h4>
                                                        <h5 class="text-muted">{{ar.titulo}}</h5>
                                                        <p>{{ar.contenido}}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                </div>-->

                            </ng-container>
                        </div>
                        <div class="row">
                        
                            <div class="col-lg-12">
                                <div class="mb-3">
                                    <label for="teammembersCompanies" class="form-label">Empresas</label>
                                    <select class="form-control form-select" aria-label="Empresas" formControlName="empresas" placeholder="Seleccione Empresas" [ngClass]="{ 'is-invalid': submitted && f['empresas'].errors }" multiple>
                                        <option value="" selected>Todos </option>
                                        <option *ngFor="let p of empresas;" value="{{p.value}}">{{p.label}}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    <!--</div>
                    </div>-->
  
                      <div class="d-flex align-items-start gap-3 mt-4"  *ngIf="subArticles.length == 0">
                        <button type="button" class="btn btn-link text-decoration-none btn-label previestab" data-previous="pills-info-desc-tab" awPreviousStep><i class="ri-arrow-left-line label-icon align-middle fs-16 me-2"></i> Artículos</button>
                        <button type="button" class="btn btn-success btn-label right ms-auto nexttab nexttab" data-nexttab="pills-success-tab" awNextStep [disabled]="cuerpoLegal.articulos.length == 0" (click)="saveAllCuerpo()"><i class="ri-arrow-right-line label-icon align-middle fs-16 ms-2"></i>Guardar y Salir</button>
                    </div>
                </aw-wizard-step>
              </aw-wizard>
            </form>
            </div>
            <!-- end card body -->
        </div>
        <!-- end card -->
    </div>
    <!-- end col -->
  </div><!-- end row -->

<app-toastl aria-live="polite" aria-atomic="true"></app-toastl>